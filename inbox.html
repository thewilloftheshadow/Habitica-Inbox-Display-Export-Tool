
<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Inbox Display & Export Tool</title>
    <base target="_blank">

<!--

This code is licensed under the same terms as Habitica:
    https://raw.githubusercontent.com/HabitRPG/habitrpg/develop/LICENSE

https://github.com/Alys/tools-for-habitrpg/blob/master/habitrpg_user_data_display.html

https://oldgods.net/habitica/cTheDragons/inbox.html

Contributors:
    cTheDragons https://github.com/cTheDragons
	based on code from
	Alys (Alice Harris), lady_alys@oldgods.net https://github.com/Alys
    thepeopleseason (James Hsiao) https://github.com/thepeopleseason
    goldfndr (Richard Finegold) https://github.com/goldfndr
    Blade Barringer https://github.com/crookedneighbor
    donoftime https://github.com/donoftime
    me_and (Adam Dinwoodie) https://github.com/me-and
	

-->

    <meta name="description" content="Inbox Display & Export Tool" />
    <meta name="author" content="cTheDragons" />

	<script src="https://code.jquery.com/jquery-1.12.3.js"></script>
	<script src="https://momentjs.com/downloads/moment-with-locales.min.js"></script>
	<script src="js/habitica-markdown.min.js"></script>
	<script src="js/api-limit.js"></script> <!-- Personal Script used to handle Ajax calls with limiting-->
	
	 <!--- https://datatables.net/download/ -->
	<script type="text/javascript" src="https://cdn.datatables.net/v/dt/jszip-2.5.0/pdfmake-0.1.18/dt-1.10.12/b-1.2.2/b-colvis-1.2.2/b-flash-1.2.2/b-html5-1.2.2/b-print-1.2.2/se-1.2.0/datatables.min.js"></script>
	<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/dt/jszip-2.5.0/pdfmake-0.1.18/dt-1.10.12/b-1.2.2/b-colvis-1.2.2/b-flash-1.2.2/b-html5-1.2.2/b-print-1.2.2/se-1.2.0/datatables.min.css"/>

	
<script type="text/javascript">
$(function() { // wraps around all our code to not pollute global namespace

//////////////////////////////////////////////////////////////////////
////   Global Variables                              /////////////////
//////////////////////////////////////////////////////////////////////

var content;  // holds site-wide content (gear names and stats, quests, etc)
var user;     // holds user's data


//////////////////////////////////////////////////////////////////////
////   Global Constants                              /////////////////
//////////////////////////////////////////////////////////////////////
var DOUBLEQUOTES = 		'"' //This is to make my life easier... 
var SINGLEQUOTE = 		"'" //This is to make my life easier...
var SECTIONREFRESH = 	"SectionRefresh"



//////////////////////////////////////////////////////////////////////
////   Sections                              /////////////////
//////////////////////////////////////////////////////////////////////

		// TO ADD NEW SECTION: To create a Table of Content entry and Main,
		// add the unique identifier for the new section to array section to Display. 
		// If it is a section that displays table content update sectionTables too. 
		// If new content is required see formatAllDataAndCollate() 
		
		//If custom sections required add to below the Sections data... (Not there yet)

var sectionsToDisplay = [	
	{type: 'sectionTable', id: 'displayInboxSection', title: 'PMs', showOnly: [], description: 'Displays personal messages you have exchanged with guild members you have fetched.'}
]

var sectionTables =	[]
sectionTables['displayInboxSection'] = {
	type: 'inbox',
	dataSet: [], 
	dataSetHeader: ['User Id', 'Username', 'Display Name', 'Tier', 'Contributor', 'Contributions', 'Mod', 'Posted', 'Epoch', 'Sent', 'Text', 'Appearance', 'Message Id'],
	dataTable: ['uuid', 'usernameNotPretty', 'userNotPretty', 'contribPretty.level', 'contribPretty.text', 'contribPretty.contributions', 'contribPretty.admin', 'creation.shortDate', 'timestamp', 'sentPretty', 'textPretty', 'userStylesPretty', 'id'],
	babyBear: {show: [1,7,9,10], orderBy: [[7, 'desc']]},
	mamaBear: {show: [1,2,3,7,9,10], orderBy: [[7, 'desc']]},
	papaBear: {show: ['all'], orderBy: [[7, 'desc']]},
	extraColumnDefs: [{'className': 'dt-center', 'targets': [6,9]}, {'className': 'dt-right', 'targets': [3,8]}],
	subTitle: function (){
		var html = ''
		return html 
	},
	pmidIndex: 12,
	uuidIndex: 0,
	nameIndex: 1
}



var exportOptions = [
	{id: 'babyBear', shortDesc: 'Baby Bear', longDesc: 'Displays & exports UserId, User, Posted, Sent, Text'},
	{id: 'mamaBear', shortDesc: 'Mama Bear', longDesc: 'Displays & exports UserId, User, Tier, Contributor, Posted, Sent, Text'},
	{id: 'papaBear', shortDesc: 'Papa Bear', longDesc: 'Displays & exports UserId, User, Tier, Contributor, Contributor Contributions, Admin, Posted, Epoch, Sent, Text'}
];
var exportFormats = [
	{id: 0, shortDesc: 'Warm Porridge', longDesc: 'Displays & exports with Emoji & Text converted but HTML removed', convertMarkup: true, removeHtml: true, convertLineBreaks: false},
	{id: 1, shortDesc: 'Hot Porridge', longDesc: 'Displays & exports in exact Habitica HTML format', convertMarkup: true, removeHtml: false, convertLineBreaks: false},
	{id: 2, shortDesc: 'Cold Porridge', longDesc: 'Displays & exports in raw format', convertMarkup: false, removeHtml: false, convertLineBreaks: true}
];
					
//////////////////////////////////////////////////////////////////////
////   Global Connection Variables      //////////////////////////////
//////////////////////////////////////////////////////////////////////
var warningMessage			= 	'PLEASE ENSURE YOUR MESSAGE IS:\n' +
								'\n\u2022 is respectful, supportive and courteous;' + 
								'\n\u2022 is not spam, including unwanted advertisements of products, social media accounts, etc;' +
								'\n\u2022 is not begging for a gift of gems or a subscription' +
								'\n\u2022 meets all requirements of the Community Guidelines of Habitica (https://habitica.com/static/community-guidelines). ' +
								'\n\u2022 meets all requirements of the Term of Service of Habitica (https://habitica.com/static/terms). ' +
								'\n' +
								'\nFailure to do so can lead to minor consequences (like warnings) to severe consequences including account bans & deletions.' +
								'\n' +
								'\nIf you have any concerns, please email Admin (admin@habitica.com) for clarification.'
var infoMessage				= 	'To add a new line type {nl}.' + 
								'\nFor a paragraph break {nl}{nl}.'

var serverName               = 'Habitica'; // used in "loading" message
var serverUrl                = 'http://8.12.22.18:8080';
var serverPathContent        = '/content?language=en';
var serverPathUser           = '/user';
var serverPathMarkRead		 = '/user/mark-pms-read'
var serverPathMessageUser	 = '/members/send-private-message'
var serverPathInbox			 = '/user/messages'	
var serverHabiticaProfile	 = 'https://habitica.com/profile/'

var userId                   = '';
var apiToken                 = '';
var markReadOption	 		 = '';
var exportOption 			 = 0;
var exportFormat			 = 0;
var rlCurrent				 = {};  //holds the Current API Remaining details - must be a better way to do this.
var debug                    = false;
var debugShowObject          = false;


if (debug || debugShowObject) serverName = '*** TURN DEBUG OFF! *** - ' + serverName
if (debug) console.log('debug 1');

var sectionOpen = ''; // holds the ID attribute of a section of the page;
                      // persists through re-fetch of data so we can
                      // reopen that section when the new data arrives
var tellMe = '<a href="https://github.com/cTheDragons">tell me</a>';

var neverDate = '1900-01-01'
var notAvailableMember = '-Member Not In Listed-'
var noUsernamePrefix = '-Unknown Username- Display Name: '

//////////////////////////////////////////////////////////////////////
////   Show API Version                   ///////////////////////////
//////////////////////////////////////////////////////////////////////
var apiVersion = getApiVersion()
$('#apiVersion').text(apiVersion);

//////////////////////////////////////////////////////////////////////
////   Allow Show/Hide Toggling to work    ///////////////////////////
//////////////////////////////////////////////////////////////////////
enableShowHideToggling(); // needed here to enable Version Changes link
var openRelatedSections = function(){} // redefined later when user data exists
function enableShowHideToggling() {
if (debug) console.log('debug enableShowHideToggling');
    // $('.showHideToggle').click(function(event)
	//Populate Selector
	var html =  getExportOptionsHtml()
	var htmlDesc =  getExportDescHtml()
	
	$('#exportOptionSelector').html(html)
	$('#exportOptionDesc').html(htmlDesc)
	
    $('body').on('click', '.showHideToggle', function(event){
		if (debug) console.log('debug body click showHideToggle');
        var target = $(this).data("target");
        var wantToShow = (! $('#' + target).is(':visible')
                       || $(this).data("forceopen"));
            // wantToShow is false if the target is already open
            // (i.e., the user wants to close it)
            // unless the toggle's attributes force it to always be
            // opened (e.g., a link from the dashboard)
        var linktext = $(this).data("linktext") || false;
		
        if ($(this).data("closemainsections")) {
            $('#MAIN > *').hide();
        } 
		
        if (wantToShow) {
            sectionOpen = target;
            $('#' + target).show();
            if (linktext) {
                $(this).text('hide ' + linktext);
            }
            openRelatedSections();
        }
        else {
            $('#' + target).hide();
            if (linktext) {
                $(this).text('show ' + linktext);
            }
            if ($(this).data("scrolltotop")) {
                window.scrollTo(0, 0);
            }
			if (sectionOpen != 'displayInboxSection') $('#MAIN > *').show();
        }
        var toggleTarget = $(this).data("resettoggletext") || false;
        if (toggleTarget) {
            $('#' + toggleTarget).text('show '
                        + $('#' + toggleTarget).data("linktext"));
        }
    });
	
    $('body').on('click', '.mainSectionClose', function(event){
		if (debug) console.log('debug body click mainSectionClose');
        $('#headerExport > *').hide();
		$('#MAIN > *').hide();
        window.scrollTo(0, 0);
    });
	
	function getExportOptionsHtml()
	{
		var html = '';
		
		html +=  '<label for="exportOption"><span>Column Option</span>'
		html +=  '<select name="exportOption" id="exportOption">';
		if (debugShowObject) console.log(exportOptions);
		$.each(exportOptions, function(index, obj){
			html += '<option value="' + obj.id + '">' + obj.shortDesc + '</option>';
		});
		html += '</select></label>'

		html +=  '<label for="exportFormat"><span>Text Format</span>'
		html +=  '<select name="exportFormat" id="exportFormat">';
		if (debugShowObject) console.log(exportOptions);
		$.each(exportFormats, function(index, obj){
			html += '<option value="' + obj.id + '">' + obj.shortDesc + '</option>';
		});
		html += '</select></label>'

		
		return html
	}
	
	function getExportDescHtml()
	{
		var html = '';
		
		html +=  '<p class="highlight">Column Options Description:</p>'
		html +=  '<ul>';
		$.each(exportOptions, function(index, obj){
			html += '<li><span class="lowlight">' + obj.shortDesc + '</span>: ' + obj.longDesc + '</li>';
		});
		html += '</ul>'

		html +=  '<p class="highlight">Text Format Description:</p>'
		html +=  '<ul>';
		$.each(exportFormats, function(index, obj){
			html += '<li><span class="lowlight">' + obj.shortDesc + '</span>: ' + obj.longDesc + '</li>';
		});
		html += '</ul>'
		
		return html
	}
}



//////////////////////////////////////////////////////////////////////
////   Get UUID from URL      ////////////////////////////////////////
//////////////////////////////////////////////////////////////////////
var url_vars = getUrlVars();
if (url_vars.hasOwnProperty("userId")) {
	$("#userId").val(url_vars.userId);
} else if (url_vars.hasOwnProperty("userid")) {
	$("#userId").val(url_vars.uuid);
} else if (url_vars.hasOwnProperty("uuid")) {
	$("#userId").val(url_vars.uuid);
}
	
if (url_vars.mark_read) {
	if ((url_vars.mark_read == "checked") || (url_vars.mark_read == "true")) {
		$("#markReadOption").prop("checked", true);
	} else {
		$("#markReadOption").prop("checked", false);
	}
} else if (url_vars.markread) {
	if ((url_vars.markread == "checked") || (url_vars.markread == "true")) {
		$("#markReadOption").prop("checked", true);
	} else {
		$("#markReadOption").prop("checked", false);
	}
} else if (url_vars.markRead) {
	if ((url_vars.markRead == "checked") || (url_vars.markRead == "true")) {
		$("#markReadOption").prop("checked", true);
	} else {
		$("#markReadOption").prop("checked", false);
	}
}


if (url_vars.hasOwnProperty("hide_avatars")) {
	if ((url_vars.hide_avatars == "checked") || (url_vars.hide_avatars == "true"))
		$("#hideAvatar").prop("checked", true);
	else {
		$("#hideAvatar").prop("checked", false);
	}
}


if (url_vars.hasOwnProperty("bear")) {
		$("#exportOption").val(url_vars.bear + "Bear");
}

if (url_vars.hasOwnProperty("porridge")) {
	var selectedPorridge = exportFormat

	$.each(exportFormats, function(index, obj){
		if (url_vars.porridge == obj.shortDesc.replace(' Porridge', '').toLowerCase()) {
			selectedPorridge = obj.id;
		}
	});	
	
	$("#exportFormat").val(selectedPorridge);
}


function getUrlVars() {
    // Function found at http://stackoverflow.com/questions/4656843/jquery-get-querystring-from-url#answer-4656873
    var vars = [], hash;
    var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
    for(var i = 0; i < hashes.length; i++)
    {
        hash = hashes[i].split('=');
        vars.push(hash[0]);
        vars[hash[0]] = hash[1];
    }
    return vars;
}


//////////////////////////////////////////////////////////////////////
////   Login events      /////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////
$('#userApiDetailsForm').submit(function(event){
if (debug) console.log('debug #userApiDetailsForm (Login Events)');
	/* The user manually submitted the API connection form. */
    userId   = $('#userId').val();
    apiToken = $('#apiToken').val();
	markReadOption = $('#markReadOption')[0].checked;
	exportOption = $('#exportOption').val()
    exportFormat = $('#exportFormat').val()
if (debugShowObject) console.log('exportFormat: ' + exportFormat );
	fetchData();
});

//////////////////////////////////////////////////////////////////////
////   Login and Data Fetch Functions   //////////////////////////////
//////////////////////////////////////////////////////////////////////
function fetchData() {
    if (debug) console.log('debug 2');
    $('#loading #serverName').text(serverName);
    $('#loading .good').show();
    $('#loading .bad' ).hide();

	var ajaxRunningCount = 2; // drops to 0 when all calls have succeeded	

	var call = []
	call.push({requestType: 'GET', urlTo: serverUrl + serverPathUser, newData: '', fnSuccess: fetchUserSuccess, fnFailure: fetchFailure, statusText: 'Asking for User Data'})
	call.push({requestType: 'GET', urlTo: serverUrl + serverPathContent, newData: '', fnSuccess: fetchContentSuccess, fnFailure: fetchFailure, statusText: 'Asking for Generic Content'})
	makeAjaxCall(call, userId, apiToken, rlCurrent)	
	
	
	
	function fetchFailure(data, rl) {
        if (debug) console.log('debug fetchFailure start');
		rlCurrent = rl
        $('#loading .good').hide();
        $('#loading .bad' ).show();
        $('#documentationAndForm').show(); // in case user has done a re-fetch
        $('#documentationAndFormClose').hide();
		$('#loading #statusError').text('Error : ' + data.responseJSON.error + '  -  ' + data.responseJSON.message ); 
		console.log(data)
        if (debug) console.log('debug fetchFailure end');
    }
	function fetchUserSuccess(data, rl) {
        if (debug) console.log('debug parseData User success start');
		rlCurrent = rl
		
        user = data.data;
		if (debugShowObject) console.log(user);
        ajaxRunningCount--;
        if (ajaxRunningCount === 0) { // all ajax calls have finished
            parseData();
        }
    }
	function fetchContentSuccess(data, rl) {
        if (debug) console.log('debug parseData Content success start');
		rlCurrent = rl
		
        content = data.data;
		if (debugShowObject) console.log(content);
        ajaxRunningCount--;
        if (ajaxRunningCount === 0) { // all ajax calls have finished
            parseData();
        }
    }
}



//////////////////////////////////////////////////////////////////////
////  Post functions      //////////////////////////////
//////////////////////////////////////////////////////////////////////
// All post functions are implemented serial as they are unreliable when performed in parallel.


//////////////////////////////////////////////////////////////////////
////  Delete All  Message			    //////////////////////////////
//////////////////////////////////////////////////////////////////////
function postDeleteAllMessages() {
	if (debug) console.log('debug postDeleteAllMessages start');
	if (confirm('Do you wish to delete all your messages from your Inbox?\n\nThere is no undo!')){
		postNextDeleteAllMessages()
	} else {
		alert('Action cancelled')
		return;
	}
	

	//This is done like this as receive ERR_INCOMPLETE_CHUNKED_ENCODING
	function postNextDeleteAllMessages(){
		$('#posting .good').show();
		
		var urlToPost = serverUrl + serverPathInbox 
		if (debugShowObject) console.log(urlToPost);
		
		var call = []
		call.push({requestType: 'DELETE', urlTo: urlToPost, newData: '', fnSuccess: postDeleteAllMessagesSuccess, fnFailure: postDeleteAllMessagesFailure, statusText: 'Deleting all messages' })
		makeAjaxCall(call, userId, apiToken, rlCurrent)
	}
		
		
	function postDeleteAllMessagesFailure(data, rl){
		if (debug) console.log('debug postDeleteAllMessagesFailure start');
		rlCurrent = rl
		
		if (debugShowObject) console.log(data);
		var errData = data;
		alert('ERROR WITH Delete All Messages \n\n' + errData.responseJSON.error + '\n' + errData.responseJSON.message  + '\n\nPlease refetch your data and try again.');	
				
		fetchData()
	}


	function postDeleteAllMessagesSuccess(data, rl){
		if (debug) console.log('debug postDeleteAllMessagesSuccess start');
		rlCurrent = rl
		
		if (debugShowObject) console.log(data);
		alert('All messages are deleted.\n\nYour data will now be refreshed.')
		
		fetchData() 
	}
	

}


//////////////////////////////////////////////////////////////////////
////  Delete PM Message			    //////////////////////////////
//////////////////////////////////////////////////////////////////////
// All post functions are implemented serial as they are unreliable when performed in parallel.
// Waiting on resolve of issues 
//     https://github.com/HabitRPG/habitica/issues/12521 & 
//     https://github.com/HabitRPG/habitica/issues/11376#issuecomment-534746769
//
function postDeleteMessage(rowData, pmidIndex, nameIndex) {
	if (debug) console.log('debug postDeleteMessage start');
	if (debugShowObject) console.log(rowData)
	var actionNotificationList = ''
	var actionItem = ''
	var actionIndex = 0
	var index = 0
	var loopList = []
	
	if (rowData.length == 0){
		if (debug) console.log('debug no users to remove');
		alert('No row selected.\nPlease select a row before trying again.');
		return;
	
	} else {
		if (debugShowObject) console.log( rowData );

		//get UniqueRows
		for(var i = 0; i < rowData.length; i++) {
			notInLoop = true
			
			for(var j = 0; j < loopList.length; j++) {
				if (rowData[i][pmidIndex] == loopList[j][pmidIndex]) {
					notInLoop = false
					break;
				}				
			}
			
			if (notInLoop) {
				loopList.push(rowData[i])
			}
		}
		
		actionIndex = loopList[0].length
		
		for(var i = 0; i < loopList.length; i++)
		{
			actionItem = loopList[i][nameIndex]
			if (actionItem.substring(0,3) == '<a '){
				actionItem = actionItem.substring(actionItem.indexOf('>')+1,actionItem.length - ('</a>').length)
			}
			actionNotificationList += '\n\u2022  ' + actionItem
			loopList[i].push(actionItem)
		}
		

		if (confirm('Are you sure you wish to delete the following messages?' + actionNotificationList + '\n\nThere is no undo!')){
			actionNotificationList = ''
			postNextDeleteMessage()
		} else {
			alert('Action cancelled')
			return;
		}
	}
	
	//This is done like this as to avoid ERR_INCOMPLETE_CHUNKED_ENCODING
	function postNextDeleteMessage(){
		$('#posting .good').show();
		
		obj = loopList[index]
		var urlToPost = serverUrl + serverPathInbox + '/' + obj[pmidIndex] 
		
		var call = []
		call.push({requestType: 'DELETE', urlTo: urlToPost, newData: '', fnSuccess: postDeleteMessageSuccess, fnFailure: postDeleteMessageFailure, statusText: 'Deleting message: ' + obj[pmidIndex] + ' (From: ' + obj[actionIndex] + ')' })
		makeAjaxCall(call, userId, apiToken, rlCurrent)
		
	}
		
	
	function postDeleteMessageFailure(data, rl){
		if (debug) console.log('debug postDeleteMessageFailure start');
		rlCurrent = rl
		if (debugShowObject) console.log(data);
		var errData = data;
		alert('ERROR WITH  ' +  obj[pmidIndex] + '\n\n' + errData.responseJSON.error + '\n' + errData.responseJSON.message  + '\n\nPlease refetch your data and try again.');	
		index++
		
		postDeleteMessageCheckCompleted()
	}


	function postDeleteMessageSuccess(data, rl){
		if (debug) console.log('debug postDeleteMessageSucess start');
		rlCurrent = rl
		
		if (debugShowObject) console.log(data);
		actionNotificationList += '\n\u2022  ' + obj[pmidIndex] + ' (From: ' + obj[actionIndex] + ')' 
		index++
		
		postDeleteMessageCheckCompleted()
	}
	
	function postDeleteMessageCheckCompleted(){
		if (index === loopList.length){
			$('#posting .good').hide();
			if (debugShowObject) console.log(actionNotificationList);
			alert('The following messages have been deleted:' + actionNotificationList + '\n\nYour data will now be refreshed')
			fetchData() 
		} else
		{
			postNextDeleteMessage()
		}		
	
	}
}

//////////////////////////////////////////////////////////////////////
////  Post Private Message			    //////////////////////////////
//////////////////////////////////////////////////////////////////////
function postMessageUser(rowData, uuidIndex, nameIndex) {
	if (debug) console.log('debug postMessageUser start');
	if (debugShowObject) console.log(rowData)
	var urlToPost = ''	
	var actionNotificationList = ''
	var actionItem = ''
	var actionIndex = 0
	var index = 0
	var privateMessage = ''
	var loopList = []
	
	if (rowData.length == 0){
		if (debug) console.log('debug no users to remove');
		alert('No row selected.\nPlease select a row before trying again.');
		return;
	
	} else {
		if (debugShowObject) console.log( rowData );
		//Check if message to be sent
		var optionalMessage = 'Thank You!'
		
		privateMessage = prompt('Please enter your private message to be sent to the users selected:\n\n' + warningMessage + '\n\n' + infoMessage, optionalMessage)

		privateMessage = privateMessage.replace(/{nl}/g,'\n');

		//get UniqueRows
		for(var i = 0; i < rowData.length; i++) {
			notInLoop = true
			
			for(var j = 0; j < loopList.length; j++) {
				if (rowData[i][uuidIndex] == loopList[j][uuidIndex]) {
					notInLoop = false
					break;
				}				
			}
			
			if (notInLoop) {
				loopList.push(rowData[i])
			}
		}
		
		actionIndex = loopList[0].length
		
		for(var i = 0; i < loopList.length; i++)
		{
			actionItem = loopList[i][nameIndex]
			if (actionItem.substring(0,3) == '<a '){
				actionItem = actionItem.substring(actionItem.indexOf('>')+1,actionItem.length - ('</a>').length)
			}
			actionNotificationList += '\n\u2022  ' + actionItem
			loopList[i].push(actionItem)
		}
		
		if ((privateMessage != undefined) && (privateMessage != '') && (privateMessage != null)) {
			if (confirm('Are you sure you wish to send\n\n' + privateMessage + '\n\n to the selected users?' + actionNotificationList + '\n\nThere is no undo!')){
				actionNotificationList = ''
				postNextMessageUser()
			} else {
				alert('Action cancelled')
				return;
			}
		} else {
			alert('Action cancelled')
			return;
		}
	}
	
	//This is done like this as to avoid ERR_INCOMPLETE_CHUNKED_ENCODING
	function postNextMessageUser(){
		$('#posting .good').show();
		
		obj = loopList[index]
		var newData = {message: privateMessage, toUserId: obj[uuidIndex]}
		var urlToPost = serverUrl + serverPathMessageUser 
		if (debugShowObject) console.log(urlToPost);
		if (debugShowObject) console.log(newData);	
		
		var call = []
		call.push({requestType: 'POST', urlTo: urlToPost, newData: JSON.stringify(newData), fnSuccess: postMessageUserSuccess, fnFailure: postMessageUserFailure, statusText: 'Messaging ' + obj[actionIndex]} )		
		makeAjaxCall(call, userId, apiToken, rlCurrent)
		
	}
		

	
	function postMessageUserFailure(data, rl){
		if (debug) console.log('debug postMessageUserFailure start');
		rlCurrent = rl
		
		if (debugShowObject) console.log(data);
		var errData = data;
		alert('ERROR WITH  ' +  obj[actionIndex] + '\n\n' + errData.responseJSON.error + '\n' + errData.responseJSON.message  + '\n\nPlease refetch your data and try again.');	
		index++
		
		postMessageUserCheckCompleted()
	}


	function postMessageUserSuccess(data, rl){
		if (debug) console.log('debug postMessageUserSucess start');
		rlCurrent = rl
		
		if (debugShowObject) console.log(data);
		actionNotificationList += '\n\u2022  ' + obj[actionIndex]  
		index++
		
		postMessageUserCheckCompleted()
	}
	
	function postMessageUserCheckCompleted(){
		if (index === loopList.length){
			$('#posting .good').hide();
			if (debugShowObject) console.log(actionNotificationList);
			alert('The following users have been messaged:' + actionNotificationList + '\n\nYour data will now be refreshed')
			fetchData() 
		} else
		{
			postNextMessageUser()
		}		
	
	}
}

//////////////////////////////////////////////////////////////////////
////  Post Private Message by Id	    //////////////////////////////
//////////////////////////////////////////////////////////////////////
function postMessageUserByUserId() {
	var toSendUserId = ''

	toSendUserId = prompt('User Id of the message to be sent to:\n\nThis is in format 00000000-0000-0000-0000-000000000000. It is not the nick of the player.' )
	
	if ((toSendUserId != undefined) && (toSendUserId != '') && (toSendUserId != null)) {
		var rowData = [[toSendUserId, toSendUserId]]
		postMessageUser(rowData, 0, 1)
	} else {
		alert('Action cancelled')
		return;
	}
	
}


//////////////////////////////////////////////////////////////////////
////  Mark PM Read					    //////////////////////////////
//////////////////////////////////////////////////////////////////////
function postMarkRead() {
	// fetch the user's own content (guilds, parties):
	
	var urlToPost = serverUrl + serverPathMarkRead
	if (debugShowObject) console.log(urlToPost);
	
	var call = []
	call.push({requestType: 'POST', urlTo: urlToPost, newData: '', fnSuccess: postMarkReadSuccess, fnFailure: postMarkReadFailure, statusText: 'Marking messages read'} )
	makeAjaxCall(call, userId, apiToken, rlCurrent)
	
	function postMarkReadFailure(data, rl) {
        if (debug) console.log('debug postMarkReadFailure start');
		rlCurrent = rl
        
		var errData = data;
		alert('ERROR WITH  ' +  obj[actionIndex] + '\n\n' + errData.responseJSON.error + '\n' + errData.responseJSON.message  + '\n\nPlease refetch your data and try again.');	
		
		postMarkReadComplete()
		
        if (debug) console.log('debug postMarkReadFailure end');
    }
	
	function postMarkReadSuccess(data, rl) {
        if (debug) console.log('debug postMarkReadSuccess start');
		rlCurrent = rl
		
		postMarkReadComplete()
    }
	
	function postMarkReadComplete() {
		$('#loading .good').hide()
	}
}


//////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////
////  Parse Data			    //////////////////////////////
//////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////
function parseData() {
	if (debug) console.log('debug parseData start');
    // variables for storing the content:
    var MAIN = {}; // each element defines the HTML for one section on the page
    var TOC  = {}; // each element defines one Table of Contents entry
    var DASHBOARD = {}; // each element defines the HTML for one dashboard tile

	var fetchtime = myDateConverter(new Date(), 'pretty');

	
    collateAndDisplayData(); //This is one function as memberActivty requires both Member and Guild data.

	userDataInHeader();
	groupDataInHeader();

	//////////////////////////////////////////////////////////////////////
    ////   Display the HTML that the functions have created   ////////////
    //////////////////////////////////////////////////////////////////////
	$('#loading .good').hide();
    $('#documentationAndFormClose').show();
    $('#documentationAndForm').hide();
	

	if (($('#MAIN')[0].innerHTML.length > 1)) {
		//Keep previous table settings
		refreshAndDisplayMAIN([]);
	} else {
		formatAndDisplayMAIN();
	}

	if (markReadOption == true) postMarkRead()
	
	
	
	function formatAndDisplayMAIN() {
		//Currently Single Section
		var keys = [];
		var keyToAdd = ''
		
		$.each(sectionsToDisplay, function(index, obj){
			keyToAdd=''
			if (obj.showOnly.length == 0 || (obj.showOnly.includes('party') && groupId == 'party') || (obj.showOnly.includes('leader') && userId == group.leader.id)){
				keyToAdd = obj.id
				if (obj.type == 'heading') keyToAdd = ''
				if (keyToAdd != '') keys.push(keyToAdd)
			}
		});
		if (debugShowObject) console.log(keys);
		
		var html = '';
		var functions = []; // functions to run after HTML code has been loaded
		var functionsPar = []; //Par to be passed in Function
		for (var i=0,ic=keys.length; i<ic; i++) {
			var data = MAIN[keys[i]];
			if (! data) {
				continue;
			}
			html += '<div id="' +
					data.id     + '">' +
					data.html   +
					//((data.longContent) ? '<div class="mainSectionClose closer">' +
					//					  'close / back to top</div>' : '') +
					'</div>';
			if (data['function']) {
				functions.push(data['function']);
				functionsPar.push(data['functionPar']);
			}
		}
		$('#MAIN').html(html);
		// execute any functions that need to be run AFTER the bulk of the
		// HTML has been created:
		$.each(functions, function(index,fn){
			var passPar = functionsPar[index];
			fn(passPar);
		});
		if (sectionOpen == '') sectionOpen = 'displayInboxSection'
		if (sectionOpen && sectionOpen  !=  'documentationAndForm'
						&& sectionOpen  !=  'versionChanges'
		) {
			// reopen the section that the user had open before re-fetching
			// data (except for sections that don't display the user's own data):
			$('#' + sectionOpen).show();
			openRelatedSections();
		}
	}

	function refreshAndDisplayMAIN(sectionToRefresh) {
		// Not required to be changed. Section controlled by Sections defined above.
		var keys = [];
		var keyToAdd = ''
		
		$.each(sectionsToDisplay, function(index, obj){
			keyToAdd=''
			if (obj.showOnly.length == 0 || (obj.showOnly.includes('party') && groupId == 'party') || (obj.showOnly.includes('leader') && userId == group.leader.id)){
				keyToAdd = obj.id
				if (obj.type == 'heading') keyToAdd = ''
				if (sectionToRefresh.length != 0) {
					$.each(sectionToRefresh, function(index2, obj2){
						if (obj.id.startsWith(obj2) == false) keyToAdd = ''
					});
				}
				if (keyToAdd != '') keys.push(keyToAdd)
			}
		});
		if (debugShowObject) console.log(keys);
		
		var html = '';		
		var functions = []; // functions to run after HTML code has been loaded
		var functionsPar = []; //Par to be passed in Function
		for (var i=0,ic=keys.length; i<ic; i++) {
			var data = MAIN[keys[i]];
			if (! data) {
				continue;
			}

			html = data.refreshHtml
			$('#' + data.id + ' #' + data.refreshId).html(html)
			
			if (data['function']) {
				functions.push(data['function']);
				functionsPar.push(data['functionPar']);
			}
		}

		// execute any functions that need to be run AFTER the bulk of the
		// HTML has been created:
		$.each(functions, function(index,fn){
			var passPar = functionsPar[index];
			fn(passPar);
		});
		
		
		if (sectionOpen == '') sectionOpen = 'displayInboxSection'
		if (sectionOpen && sectionOpen  !=  'documentationAndForm'
						&& sectionOpen  !=  'versionChanges'
		) {
			// reopen the section that the user had open before re-fetching
			// data (except for sections that don't display the user's own data):
			$('#' + sectionOpen).show();
			openRelatedSections();
		}
	}
	
	openRelatedSections = function() {

	}
	
	function userDataInHeader() {
		var displayName = user.profile.name;
		
		$('#headerExtras').html('<div id="userNameDisplay">' +
				displayName +
				'</div>' +
				'<div id="explanationAndClearLinks">' +
				'<input id="refetch" type="submit" value="' +
				'Re-Fetch Data (last fetched ' + fetchtime + ')" />' +
				'<span id="documentationAndFormToggle" class="showHideToggle" data-target="documentationAndForm" data-linktext="documentation & options" data-closemainsections="true">show documentation & options</span>' +
				'</div>'  				
				
		);
		$('#refetch').click(function(event){
			/* The user clicked on the Re-Fetch My Data button. */
			$(document).unbind('click'); //remove random elements listeners
			$(document).unbind('change'); //remove random elements listeners
			fetchData();
		});
	}

	function groupDataInHeader() {
		
	
		$('#headerGroupExtras').html('<div id="groupNameDisplay">' +
				sectionTables["displayInboxSection"].dataSet.length +
				' messages in Inbox. ' +
				'&nbsp;&nbsp;&nbsp;&nbsp;'+
				'<input id="deleteAllMessages" type="submit" value="Delete All Messages" />' +
				'&nbsp;&nbsp;&nbsp;&nbsp;'+
				'<input id="messageByUserId" type="submit" value="Message By User Id" />' +
				'</div>'  	
		
		);
		$('#deleteAllMessages').click(function(event){
			postDeleteAllMessages()
		});
		$('#messageByUserId').click(function(event){
			postMessageUserByUserId()
		});
		
	}
	

	//////////////////////////////////////////////////////////////////////
    ////   Formatting Functions used throughout  			  ////////////
    //////////////////////////////////////////////////////////////////////	
	
	function myDateConverter(date, style) { 

		var dateStr = '';
					
		if (style === 'pretty') {
			dateStr = moment(date).format('Do MMM YYYY, H:mm:ss');
		} else if (style === 'short') {
			if (date == neverDate) {
				dateStr = '-N/A-'
			} else {
				dateStr = moment(date).format('YYYY-MM-DD H:mm:ss');
			}
		} else if (style === 'long') {
			dateStr = moment(date).format('ddd Do MMMM YYYY, h:mm:ss a');
		} else if (style === 'utcTime') {
			dateStr = moment(date).utc().toISOString();
		} else if (style === 'relativeTime') {
			if (date == neverDate) {
				dateStr = '-N/A-'
			} else {
				dateStr = moment(date).fromNow();
			}
		}	else {
			var dateStr = moment(date).format(style);
		}
		return dateStr;
	}

	
	function renderFormattedText(text, options) {
		var md = window.habiticaMarkdown;
		if (text != undefined) {
			if (exportFormats[exportFormat].convertMarkup) text = md.render(text);
			if (exportFormats[exportFormat].removeHtml) text = $(text).text();
			if (exportFormats[exportFormat].convertLineBreaks) text = text.replace(/(?:\r\n|\r|\n)/g, '<br />');
			if (options && options.removeParaTags) {
				text = String(text).replace(/^<p>|<\/p>\n$/g, '');
			}
			else if (options && options.setParaClass) {
				text = String(text).replace(/<p>/g,
						   '<p class="' + options.setParaClass + '">');
			}
		}
		return text;
	}


	function renderFormattedText(text, options) {
		var md = window.habiticaMarkdown;
		if (text != undefined) {
			if (exportFormats[exportFormat].convertMarkup) text = md.render(text);
			if (exportFormats[exportFormat].removeHtml) text = $(text).text();
			if (exportFormats[exportFormat].convertLineBreaks) text = text.replace(/(?:\r\n|\r|\n)/g, '<br />');
			if (options && options.removeParaTags) {
				text = String(text).replace(/^<p>|<\/p>\n$/g, '');
			}
			else if (options && options.setParaClass) {
				text = String(text).replace(/<p>/g,
						   '<p class="' + options.setParaClass + '">');
			}
		}
		return text;
	}
	
	function toTitleCase(str)
	{
		return str.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
	}
	
	function constructTable(passPar) {
		//Called in Main to display table(s).
		//Will need to be added to add buttons and row selection on the fly.
		var formattedTableHeader = [];
		var dataSetSectionId = passPar[0];
		var dataSetTable = passPar[1];
		var dataSetTableHeader = passPar[2];
		var dataSetTableSection = passPar[3];
		
		var defaultShow = []
		var defaultOrderBy = []
		var buttonCollectionColumnOption = []
		var selectValue = false
		var showButtons = []
		var allColumnDefs = []
		
		var showOptions = []
		var hideOptions = []
		
		if (debug) console.log('debug constructTable ' + dataSetSectionId);		
		
		if ($('#'+ dataSetTableSection)[0].rows.length != 0){
			if (debug) console.log ('Table exists')

			var table = $('#'+ dataSetTableSection).DataTable();

			table.clear();
			table.draw();
				
			table.rows.add(dataSetTable);
			table.draw()
		} else {
			if (debug) console.log ('Table does not exists')
			//create column header
			$.each(dataSetTableHeader, function(index, obj){
				formattedTableHeader.push({'title': obj, 'classname': dataSetTableSection + '_' + obj.replace(/ /g, ''),  'defaultContent': ''})
			});
			
			if (debugShowObject) console.log(formattedTableHeader);
			
			
			showButtons = formatShowButton()
			
			if (debugShowObject) console.log(showButtons);

			allColumnDefs = [
				{ targets: defaultShow, visible: true},
				{ targets: '_all', visible: false }
			]
			allColumnDefs = allColumnDefs.concat(sectionTables[dataSetSectionId].extraColumnDefs)
			
			if (debugShowObject) console.log(allColumnDefs);

			
			sectionTables[dataSetSectionId].events = $('#events');
			$(document).ready(function() {
				sectionTables[dataSetSectionId].table = $('#'+ dataSetTableSection).DataTable( {
					data: dataSetTable,
					columns: formattedTableHeader,
					columnDefs: allColumnDefs,
					order: defaultOrderBy,
					lengthMenu: [ [10, 25, 50, 100, 200, 500, -1], [10, 25, 50, 100, 200, 500, "All"] ],
					select: selectValue, 
					dom: 'Bfrtip',
					buttons: showButtons
					
				} );
			} );
		}
		
		function formatShowButton() {
			var returnButtons = []
		
		
			//create export options
			$.each(exportOptions, function(index, obj){
				
				//Work out the hidden column list
				showOptions[obj.id] = eval('sectionTables[dataSetSectionId].' + obj.id + '.show')
				hideOptions[obj.id] = [];
				
				if (showOptions[obj.id][0] == 'all'){
					showOptions[obj.id] = []; // clear array
					for (i = 0; i < sectionTables[dataSetSectionId].dataTable.length; i++) { 
						showOptions[obj.id].push(i)
					}
					
				} else {
					for (i = 0; i < sectionTables[dataSetSectionId].dataTable.length; i++) { 
						if (showOptions[obj.id].indexOf(i) == -1) hideOptions[obj.id].push(i)
					}
				}
				buttonCollectionColumnOption.push({
									extend: 'colvisGroup',
									text: obj.shortDesc,
									show: showOptions[obj.id],
									hide: hideOptions[obj.id],
									className: 'columnGroupButton'
								})					
			});
			buttonCollectionColumnOption.push('columnsToggle')
			defaultShow = showOptions[exportOption]
			defaultOrderBy = eval('sectionTables[dataSetSectionId].' + exportOption + '.orderBy')
			
			if (debugShowObject) console.log(showOptions);		
			if (debugShowObject) console.log(hideOptions);	
		
			returnButtons = [
				 'pageLength', 
				 {
					extend: 'collection',
					text: 'Show/Hide',
					buttons: buttonCollectionColumnOption
				},
				{
					text: exportFormats[0].shortDesc,
					action: function ( e, dt, node, config ) {
						exportFormat = exportFormats[0].id;
						parseData();
					}
				},
				{
					text: exportFormats[1].shortDesc,
					action: function ( e, dt, node, config ) {
						exportFormat =  exportFormats[1].id;
						parseData();
					}
				},
				{
					text: exportFormats[2].shortDesc,
					action: function ( e, dt, node, config ) {
						exportFormat =  exportFormats[2].id;
						parseData();
						}
				},
				{
					extend: 'collection',
					text: 'Print/Copy/Export',
					buttons: [ 
						 {
							extend: 'print',
							exportOptions: {
								columns: ':visible'
							}
						}, {
							extend: 'copy',
							exportOptions: {
								columns: ':visible'
							}
						}, {
							extend: 'pdf',
							filename: 'inbox',
							exportOptions: {
								columns: ':visible'
							}	
						}, {
							extend: 'excel',
							filename: 'inbox',
							exportOptions: {
								columns: ':visible'
							}	
						}, {
							extend: 'csv',
							filename: 'inbox',
							exportOptions: {
								columns: ':visible'
							}	
						}						
					],
					autoClose: true
				}
			]

			//Leadership buttons
			var chatMessageButton = [
				{
					text: 'Delete Message',
					action: function ( e, dt, node, config ) {
						var rowData = sectionTables[dataSetSectionId].table.rows( { selected: true } ).data().toArray();
						var pmidIndex = sectionTables[dataSetSectionId].pmidIndex;
						var nameIndex = sectionTables[dataSetSectionId].nameIndex;
						postDeleteMessage(rowData, pmidIndex, nameIndex)
					},
					className: 'deleteMessageButton'		
				},
				{
					text: 'Message User',
					action: function ( e, dt, node, config ) {
						var rowData = sectionTables[dataSetSectionId].table.rows( { selected: true } ).data().toArray();
						var uuidIndex = sectionTables[dataSetSectionId].uuidIndex;
						var nameIndex = sectionTables[dataSetSectionId].nameIndex;
						postMessageUser(rowData, uuidIndex, nameIndex)	
					},
					className: 'messageUserButton'
				}
			]
			returnButtons = returnButtons.concat(chatMessageButton)
			selectValue = true
			
			if (sectionTables[dataSetSectionId].extraButton != undefined) {
				var extraButton = sectionTables[dataSetSectionId].extraButton();
				returnButtons = returnButtons.concat(extraButton)
				selectValue = true
			}
			
			return returnButtons
		}


	}




	
	//////////////////////////////////////////////////////////////////////
    ////   Collate and Display Data  					 ////////////
    //////////////////////////////////////////////////////////////////////	
	function collateAndDisplayData() {
		//rearrange data
		
		//format collate Data -- one function
		formatAllDataAndCollate();
		
		//run functions to create for TOC / MAIN 
		$.each(sectionsToDisplay, function(index, obj){
			if (obj.type == 'sectionTable') {
				if (obj.showOnly.length == 0 || (obj.showOnly.includes('party') == true && groupId == 'party') || (obj.showOnly.includes('leader') == true && ((userId == group.leader.id) || (userIsAdmin)))) {
					formatTableSection(obj.id, obj.title)
				}
			} else if (obj.type == 'sectionCustom') {
				var fn = obj.functionCreate
				eval(fn + '("' + obj.id + '", "' + obj.title + '")')
			}
			
		});
		
		
		
	//////////////////////////////////////////////////////////////////////
    ////   Prep data before using                            ////////////
	//
	//     This is where you modify data to be used throughout
	//     All data is modified here
    //////////////////////////////////////////////////////////////////////
		function formatAllDataAndCollate() {
			if (debug) console.log('debug formatAllDataAndCollate')
			var arrayToAdd = []; 
			
			//inbox data format and collate
			
			//Clear arrays
			//$.each(sectionsToDisplay, function(index, obj){
			//	if (obj.type == 'sectionTable'){
			//		sectionTables[obj.id].dataSet=[];
			//	}
			//});
			sectionTables['displayInboxSection'].dataSet=[];
			

			$.each(user.inbox.messages, function(index, obj){
				modifyInboxProperties(obj);

				$.each(sectionsToDisplay, function(index2, obj2){
					if (obj2.type == 'sectionTable' && (obj2.showOnly.includes('party') != true || groupId == 'party')) {
						if (sectionTables[obj2.id].type == 'inbox'){
							addToArray = []; //clear array
							$.each(sectionTables[obj2.id].dataTable, function(index3, obj3){
								addToArray.push(eval('obj.' + obj3))
							});
							//Don't include system messages if chatNotSystemExport
							sectionTables[obj2.id].dataSet.push(addToArray); 
						}
						
					}
				});

			});
			if (debugShowObject) console.log(sectionTables);
		};
		
		function modifyInboxProperties(obj) {
			obj.textPretty  = renderFormattedText(obj.text, {'setParaClass':'chatText'});
			if (obj.uuid == 'system') {
				obj.userPretty = 'System'
				obj.userNotPretty = 'System'
				obj.username = 'System'
				obj.usernameNotPretty = 'System'
				obj.usernamePretty = 'System'
				obj.userStylesPretty = ''
			} else {
				obj.userPretty = '<a href="' + serverHabiticaProfile + obj.uuid + '" target="_blank">' + renderFormattedText(obj.user) + '</a>';
				obj.userNotPretty = '<a href="' + serverHabiticaProfile + obj.uuid + '" target="_blank">' + renderFormattedText(obj.user, {removeParaTags: true}) + '</a>';
				if (obj.username == undefined) {
					obj.username = noUsernamePrefix + obj.user
					obj.usernameNotPretty = '<a href="' + serverHabiticaProfile + obj.uuid + '" target="_blank">' + noUsernamePrefix + obj.user + '</a>';
				} else {
					obj.usernameNotPretty = '<a href="' + serverHabiticaProfile + obj.uuid + '" target="_blank">' + obj.username + '</a>';
				}
				obj.usernamePretty = obj.usernameNotPretty
				
				if (obj.userStyles != undefined) {
					obj.userStylesPretty = JSON.stringify(obj.userStyles, null, ' ').replace(/: \{\n\s+/g, ': {').replace(/",\n\s+/g, ', ').replace(/"\n\s+\}/g, '}').replace(/(\r\n|\n|\r)/g,"<br />").replace(/"  "/g, '&nbsp;&nbsp');;
				} else {
					obj.userStylesPretty = ''
				}
				
			}
			obj.creation  = reformatDate(obj.timestamp);
			//if (debugShowObject) console.log(obj);
			if (obj.contributor  !=  undefined ) {
				if (obj.contributor.text  !=  undefined ) {
					obj.contribPretty = [];
					obj.contribPretty.text = obj.contributor.text;
					if (obj.contributor.level != undefined)	{
						obj.contribPretty.level = obj.contributor.level
					} else {
						obj.contribPretty.level = '';
					};
					if (obj.contributor.contributions  !=  undefined){
						obj.contribPretty.contributions = obj.contributor.contributions;
					} else {
						obj.contribPretty.contributions = '';
					}
					if (obj.contributor.admin === true) {
						obj.contribPretty.admin = true
					} else {
						obj.contribPretty.admin  = false
					}
				} else {
					obj.contribPretty = [];
					obj.contribPretty.text = '';
					obj.contribPretty.level = '';
					obj.contribPretty.contributions = '';
					obj.contribPretty.admin = false;
				}
			} else {
				obj.contribPretty = [];
				obj.contribPretty.text = '';
				obj.contribPretty.level = '';
				obj.contribPretty.contributions = '';
				obj.contribPretty.admin = false;
			}
			if (obj.sent === true) {
				obj.sentPretty = 'true'
			} else {
				obj.sentPretty = 'false'
			}
		}
		
		function reformatDate(dateString) {
				var formattedDate = myDateConverter(dateString, 'long');
				var shortDate     = myDateConverter(dateString, 'short');
				var relativeTime  = myDateConverter(dateString, 'relativeTime');
				var utcTime  = myDateConverter(dateString, 'utcTime');
				return { 'dateAndTime': formattedDate,
						 'shortDate': shortDate,
						 'relativeTime': relativeTime,
						 'utcTime': utcTime
				};
		}

		function createAvatar (user) {
			if (hideAvatar == false) {
				var wrapper = document.createElement('div');
				
				wrapper.appendChild(window.habiticaAvatar({user: user}));
				
				return wrapper.innerHTML;
			}
		}

		//////////////////////////////////////////////////////////////////////
		////   Sections 										   ////////////
		//////////////////////////////////////////////////////////////////////
		//Custom Section functions here.
		
		function formatTableSection(sectionId, title){
			var id    = sectionId + 'Section';
			var orderId = sectionId;
			var tableSectionId = sectionId + 'display';
			var subTitle = sectionTables[sectionId].subTitle()
			var refreshId = sectionId + SECTIONREFRESH 
			var html = formatTableData(subTitle, refreshId, tableSectionId);
			if (! html) {
				return;
			}
			TOC[orderId] = {'target': id, 'title':  title};
			MAIN[orderId] = {'id': id, 'title': title, 'longContent': true,
				'html': html, 'refreshHtml': subTitle, 'refreshId': refreshId,
				'dataSetTblSection': tableSectionId, 'function': constructTable, 
				'functionPar':  [sectionId, sectionTables[sectionId].dataSet, sectionTables[sectionId].dataSetHeader, tableSectionId]};
		}
		
		
		//Function used by sections to create HTML To display table
		function formatTableData(subText, refreshId, tableId) {
			//Used by sections above if a table is required in there HTML
			var html = '';
			
			html += '<table id="' + tableId + '" class="display" width="100%"></table>'

			if (html) {
				return '<span id="' + refreshId + '">' + subText + '</span><p><div id="headerExport"></div></p>' + html ;
			}
			else {
				return '';
			}
		}
	
	}
}	//parseData



if (debug) console.log('debug 99');	
});
</script>	
<style>

/*********************************************************************
****   Page-wide   ***************************************************
*********************************************************************/
body {
    font-family: Helvetica, Arial, sans-serif;
    font-size: 14px;
    background-color: rgb(173, 208, 215);
}
#innerBody {
    margin: 20px;
    padding: 5px 20px 30px 20px;
    background-color: rgb(242, 242, 230);
}
#loading {
    margin-right: 30px;
    margin-left: 30px;
    color: orange;
    font-size: 1.5em;
    font-weight: bold;
}
#loading ul {
    font-size: 0.8em;
}
#loading ul a {
    color: orange;
}

.narrowContent {      /* The data should be as wide as the user's window   */
    max-width: 500px; /* but some explanatory paragraphs should be narrow. */
}


hr {
    width: 95%;
}
hr.padded {
    margin-top:    1em;
    margin-bottom: 2em;
}

.show {
    display: block;
}
.hide {
    display: none;
}
.clear {
    clear: both;
}

.subheading {
    font-weight: bold;
}
.highlight {
    font-weight: bold;
}
.lowlight { /* like highlight but less so */
    font-style: italic;
}
.explanation {
    font-style: italic;
}
abbr {
    border-bottom: 1px dashed black;
}
img.emoji {
    margin-bottom: -0.25em;
}
.forCopyPaste {
    /* used to add blank lines that we want when copying text to clipboard,
       but we don't want to see extra whitespace on the screen */
    margin-top: -1em;
}
ul.padded > li {
    padding: 3px 0;
}

.neutral {
    background-color: #fffbd0; /* yellow */
}
.danger {
    background-color: #ffcccc; /* red */
    /* background-color: #F5A9A9; */ /* darker red */
}
.safe {
    background-color: #bdd8fc; /* blue */
    /* green+red and green+yellow are not good for colour-blind people */
}

/*********************************************************************
****   Page-wide Data Tables   ********************************
*********************************************************************/
a.dt-button.deleteMessageButton {
	color: orange;
}

a.dt-button.messageUserButton {
	color: orange;
}


    
/*********************************************************************
****   Page-wide Show/Hide Toggling   ********************************
*********************************************************************/
.mainSectionClose,
.showHideToggle,     /* for toggling by id */
.showHideToggleClass /* for toggling by class */
{
    cursor: pointer;
    text-decoration: underline;
    color: purple;
}
.closer { /* as in "a thing that closes", not "nearer" */
    margin-top: 30px;
    padding-top: 15px;
    padding-bottom: 15px;
}
.closer:hover {
    border: 1px dashed lightgrey;
}
.developerData {
    font-family: monospace;
}


/*********************************************************************
****   Header   ******************************************************
*********************************************************************/
h1 {
    float: left;
}
h1>a:first-child { /* "Habitica" link in header */
    color: black;
    text-decoration: none;
}
h1>a:first-child:hover { /* "Habitica" link in header */
    text-decoration: underline;
}
h1 span {
    font-size: 0.5em;
}
h1 span span {
    font-size: 1.0em;
}
h2 {
    margin-top: 30px;
}

#headerExtras .showHideToggle {
    white-space: nowrap;
}
#userNameDisplay {
    text-align: right;
    font-weight: bold;
    font-size: 2em;
    margin-bottom: 10px;
}

#groupNameDisplay {
    text-align: left;
    margin-bottom: 10px;
}

#explanationAndClearLinks {
    text-align: right;
}
#explanationAndClearLinks span {
    padding-left: 10px;
}


/*********************************************************************
****   Version History   *********************************************
*********************************************************************/

#versionChanges dl {
    margin-left: 30px;
}
#versionChanges dl dt {
    font-size: 1.15em;
    font-weight: bold;
}
#versionChanges dl dt .date {
    padding-left: 10px;
    font-size: 0.8em;
    font-weight: normal;
}
#versionChanges .showHideToggle {
    padding-bottom: 15px;
    margin-bottom: 10px;
}
/*********************************************************************
****   Header Export Options  *********************************************
*********************************************************************/
#headerExport div {
	display: inline;
	align-items: center;
	text-align: center;
	padding: 5px;
	position: relative;
}

#exportCSVFile input {
	align-items: center;
	text-align: center;
	
}
#exportTabDelimFile input {
	align-items: center;
	text-align: center;
} 


/*********************************************************************
****   API Form and Documentation   **********************************
*********************************************************************/

#documentationAndForm > div {
    max-width: 700px;
}
#documentationAndForm #documentationAndFormClose {
    display: none;
    max-width: 100%;
}
#documentationAndForm div h2 {
    font-size: 1.3em;
}
#documentationAndForm li {
    margin-bottom: 10px;
}

#userApiDetailsForm {
    margin: 30px;
}
#userApiDetailsForm fieldset {
    max-width: 40em;
}
#userApiDetailsForm fieldset label,
#userApiDetailsForm fieldset input[type="submit"] {
    display: block;
    float: left;
    clear: left;
    margin: 10px 0;
}
#userApiDetailsForm fieldset label span {
    display: block;
    float: left;
    width: 8em;
}
#userApiDetailsForm fieldset label input {
    float: left;
    width: 30em;
}
#userApiDetailsForm input[type="checkbox"] {
    width: auto;
}
#userApiDetailsForm fieldset p {
    clear: both;
}
#userApiDetailsForm legend .highlight {
    font-size: 1.3em;
}
#userApiDetailsForm fieldset li {
    margin-bottom: 7px;
}



/*********************************************************************
****   Dashboard   ***************************************************
*********************************************************************/


/*********************************************************************
****   Table Of Contents   *******************************************
*********************************************************************/


/*********************************************************************
****   Specific Sections   *******************************************
*********************************************************************/
#displayInboxSection h3 {
    margin-top: 2em;
}

</style>
</head>
<body><div id="innerBody">	
<h1><a href="https://habitica.com/">Habitica</a> Inbox Display & Export Tool
    <span class="showHideToggle" data-target="versionChanges" data-closemainsections="true">(v3.0- vApi<span class="apiVersion" id="apiVersion"> NOT INSTALLED !</span>)</span></h1><!-- VERSION TOGGLE -->
<div id="headerExtras"></div>
<hr class="clear" />
<div id="headerGroupExtras"></div>
<hr class="clear" />


<div id="loading">
    <div class="good hide">
		<p>Please wait. <span id="statusCallType">Fetching</span> data from
        <span id="serverName">Habitica</span>... <span id="statusMessage"></span></p>
		<p><span id="statusWait"></span></p>
    </div>
    <div class="bad hide">
        <p>There was an error obtaining your data.</p>
        <ul class="padded">
            <li>Please reload the page and then check that your <a href="https://habitica.com/user/settings/api">User ID and API Token</a> are correct.</li>
            <li>If you're using Internet Explorer, try another browser. <a href="https://www.google.com/intl/en/chrome/browser/">Chrome</a> or <a href="https://www.mozilla.org/en-US/firefox/new/">Firefox</a> will be more reliable.</li>
            <li>If the page's URL starts with "http://" change it to start with "https://" (or just use <a href="https://oldgods.net/habitica/cTheDragons/inbox.html">this correct link</a>).</li>
            <li>If neither of those help, contact me! See <strong>"Help and Contact Details"</strong> at the bottom of this page.</li>
        </ul>
		<span id="statusError"></span></p>
    </div>
</div>
<div id="versionChanges" class="hide"><!-- VERSION SECTION -->
    <h2>Version History</h2>
    <dl>
		<dt>3.0 - Cookie Cutter<span class="date">2020-09-03</span></dt>
        <dd><ul>
		 	<li>Features:
                <ul>
					<li>Handling the new Habitica API Limits. </li>
					<li>Showing version of API as well as version of tool</li>
				</ul> 
            </li>
		</ul></dd>
		<dt>2.3 - One should not release code at 4am in morning<span class="date">2019-05-01</span></dt>
        <dd><ul>
		 	<li>Features:
                <ul>
					<li>Made usernames and display names linked to Habitica Profile Page.</li>
				</ul> 
            </li>
 			<li>Documentation:
                <ul>
					<li>Updated reference for spam email address to generic Admin.</li>
                </ul>
            </li>
			<li>Bug Fixes:
                <ul>
					<li>Handled if username is not set.</li>
				</ul>
			</li>	
		</ul></dd>
		<dt>2.2 - Missing on delete<span class="date">2019-04-29</span></dt>
        <dd><ul>
            <li>Bug Fixes:
                <ul>
					<li>Put Message Id back, so messages can be deleted.</li>
				</ul>
			</li>	
		</ul></dd>
		<dt>2.1 - Time for a Service<span class="date">2019-04-29</span></dt>
        <dd><ul>
	        <li>Features:
                <ul>
					<li>Adding usernames (with alt if username not defined).</li>
					<li>Refactor URL input</li>
					<li>Able to put carriage returns into message (Clunky but will do for now).</li>
				</ul> 
            </li>
			<li>Documentation:
                <ul>
					<li>Updated email to admin@habitica.com regarding spam messages.</li>
                </ul>
            </li>				
	        <li>Bugs:
                <ul>
					<li>Fixed the showing and hiding documentation. No need to refresh to show/hide now!</li>
                </ul>
            </li>		
		</ul></dd>	
		<dt>2.0 - Top Down<span class="date">2017-11-14</span></dt>
        <dd><ul>
	            <li>Features:
                <ul>
					<li>Added ability to reply messages.</li>
					<li>Added ability to delete selected messages.</li>
					<li>Added ability to delete ALL messages.</li>
					<li>Added ability to send messages with User ID only.</li>
					<li>Updating URL to new website format.</li>
					<li>Better error with POST functions handling.</li>
				</ul> 
            </li>
	        <li>Documentation:
                <ul>
					<li>Clean up of code. (LOTS AND LOTS)</li>
					<li>Minor fixes to formatting of check boxes.</li>
                </ul>
            </li>		
		</ul></dd>		
		<dt>1.7 - Nothing Flash But Nice To Know<span class="date">2017-08-19</span></dt>
        <dd><ul>
            <li>Features:
                <ul>
					<li>Names now render with markdown based on porridge option.</li>
				</ul> 
            </li>		
	        <li>Bug Fixes:
                <ul>
                    <li>Removed incorrect references to the Data Display Tool. (Thank you @Alys)</li>
					<li>Cold porridge now shows carriage returns.</li>
					<li>Better handling of null strings with markdown.</li>
               </ul>
            </li>
		</ul></dd>	
		<dt>1.6 - Minor Rearrange<span class="date">2017-01-16</span></dt>
        <dd><ul>
            <li>Documentation Code
                <ul>
					<li>Moving Null.html out of the top directory</li>
					<li>Cleaning up documentation</li>
				</ul>
			</li>	
		</ul></dd>
		<dt>1.5 - That is where that typo went! <span class="date">2016-12-07</span></dt>
        <dd><ul>
            <li>Documentation:
                <ul>
                    <li>Minor Document updates on what on this page.</li>
				</ul>
            </li>
		</ul></dd>
	    <dt>1.4 - That is where that typo went! <span class="date">2016-12-05</span></dt>
        <dd><ul>
            <li>Documentation:
                <ul>
                    <li>Fixing text regarding Warm Porriage (Thank you @Floodid & @CloJo)</li>
				</ul>
            </li>
		</ul></dd>
       <dt>1.3 - More export and columns selections. Making Firefox compatible <span class="date">2016-11-16</span></dt>
        <dd><ul>
            <li>Features:
                <ul>
                    <li>Upgrade to select / deselect all columns</li>
					<li>Added Print, copy and export to excel options</li>
					<li>Retired TAB format to remain compatible with firefox.</li>
				</ul>
            </li>
		</ul></dd>
        <dt>1.2 - Mark Inbox as Read <span class="date">2016-11-02</span></dt>
        <dd><ul>
            <li>Features:
                <ul>
                    <li>Giving the option to mark item as read</li>
				</ul>
            </li>
		</ul></dd>
		<dt>1.1 - Serving Porridge <span class="date">2016-10-15</span></dt>
        <dd><ul>
            <li>Features:
                <ul>
                    <li class="subheading">Created Porriage options</li>
					<li>Allowed text to be rendered in Habitica Markup format</li>
					<li>Create format that removed all html tags</li>
                    <li>Moved Export bar to Main area</li>
					<li>Sources moved to external documents</li>
                </ul>
            </li>
		</ul></dd>
        <dt>1.0 - initial release <span class="date">2016-10-12</span></dt>
        <dd><ul>
            <li>Features:
                <ul>
                    <li class="subheading">Inbox Data Listing in Table Format</li>
					<li class="subheading">Export of Inbox in CSV format</li>
                    <li class="subheading">Export of Inbox in Tab Delimited format</li>
                </ul>
            </li>
            <li>Documentation:
                <ul>
                    <li>Privacy and security notes (also related comments within the code)</li>
                    <li>What's On This Page? (descriptions of each feature)</li>
                    <li>Possible Future Features</li>
                    <li>Suspected Bugs (no support for old browsers; mobile support unknown)</li>
                    <li>Help and Contact Details</li>
                </ul>
            </li>
        </ul></dd>
    </dl>
    <div class="showHideToggle closer" data-target="versionChanges" data-scrolltotop="true">close version history <span class="lowlight">(or click the version number again to close)</span></div>
    <hr />
</div><!-- end of div id="versionChanges" -->


<div id="DASHBOARD"></div>
<div id="TOC"></div>
<div id="MAIN"></div>


<div id="documentationAndForm">
   <p>This page shows you certain information from your <a
   href="https://habitica.com/">Habitica</a> account. You can read the
   full list below, or just enter your details and try it out.</p>

    <iframe src="js/null.htm" id="formPasswdSaveFix" name="formPasswdSaveFix" style="display:none"></iframe><!-- DAMN YOU CHROME!! DAMN YOU!!!! http://stackoverflow.com/a/9116737 -->
    <form id="userApiDetailsForm" method="POST" action="" target="formPasswdSaveFix">
        <fieldset>
            <legend><span class="highlight">Enter your Habitica API details</span>
            (from the <a href="https://habitica.com/user/settings/api">Settings
             -&gt; API page</a>)
            </legend>
            <label for="userId"><span>User ID</span>
                <input type="text" name="userId" id="userId" />
            </label>
            <label for="apiToken"><span>API Token</span>
                <input type="password" name="apiToken" id="apiToken" />
            </label>
			<label for="markReadOption"><span>Clear Message Notification?</span>
                <input type="checkbox" name="markReadOption" id="markReadOption" checked/>
            </label>
			<div id="exportOptionSelector"></div>
            <input type="submit" value="Fetch My Inbox Data" />
			<p>To ensure quick loads, only use one instance of Third Party Tool at a time.</p>
			<div id="exportOptionDesc"></div>
            <p class="highlight">Privacy and security notes:</p>
            <ul>
            <li>Your API Token is a password - do not share it with anyone,
            not even the maintainer of this page if you are seeking help.</li>
            <li>When you enter your User ID and API Token here and click
            "Fetch My Data", your ID and Token are sent to Habitica's servers.
            They are not sent anywhere else.
            To confirm that, you can ask someone who knows the JavaScript
            programming language to examine the source of this page.</li>
            <li>This page does not save your User ID and API Token to any
            location, but your browser might, if it has been configured to
            save form and password information. If you are using this page
            on a shared computer, you should clear any data that the browser
            has saved.</li>
            <li>You cannot view anyone else's private data by using this page.</li>
            <li>To clear your data, reload the page.</li>
            </ul>
        </fieldset>
    </form>


    <div>
       <h2>What's On This Page?</h2>
       <ul>
            <li><span class="subheading">Inbox Listing Table Format</span>: A table listing personal inbox messages with option to export, print or copy to clipboard.</li>
       </ul>

	<h2>Possible Future Features</h2>
       <ul>
		<li>A nicer multi line box when posting messages. (This will need to be done by someone else as the code is currently beyond me)<li>
		<li><span class="subheading">Other Stuff?</span>: Send me ideas! Contact details are below.</li>
       </ul>

       <h2>Known Bugs</h2>
       <p>Internet Explorer will produce odd results if you use the "Re-Fetch Data" button. Reloading the page will fix the problem. Avoid using that button. Avoiding Internet Explorer will also work.</p>
       <p>This page will not work correctly on old browsers because it uses modern website features and relies on compliance to standards (both can be lacking in old browsers). <a href="http://browsehappy.com/">Updating your browser is important for general safety on the internet!</a> If you have upgraded your browser to the latest version and are still having problems, please tell me! Contact details are below.</p>
       <p>Regardless of what bugs there might be, this page cannot damage your account. It does not contain any code that could result in any changes being made on Habitica except actions performed through this website/API.</p>

	   <h2>Thank You!</h2>
	   <p>Thank you to @Alys & Ryan for their code which this is based. Thank you all in the <a href="https://habitica.com/groups/guild/349a36c3-66f3-4bf8-91b6-475056d9b6bb">Javascript</a> and <a href="https://habitica.com/groups/guild/2ff9822b-27f2-4774-98da-db349b57a38e">Aspiring Comrades</a> in answering my newbie questions.<p> 
	   
       <h2>Help and Contact Details</h2>
		<p>This page has been created by <a href="http://habitica.wikia.com/wiki/User:CTheDragons">cTheDragons</a>. If you have questions, problems, or suggestions, you're welcome to contact me, although I cannot guarantee that I'll always be able to spend a lot of time on this. You can contact me at <a href="https://habitica.com/groups/guild/d9a0ec1e-352b-4697-a5d5-fb45c98fb4a3">Testing & Bug Squashing for Dragon Tools</a>. I tend to ignore emails & PMs.</p>
	    <p>Code can be source at  <a href="https://github.com/cTheDragons/Habitica-Inbox-Display-Export-Tool">Github<a>. Contributions are welcome. As already stated, any issues please report to  <a href="https://habitica.com/groups/guild/d9a0ec1e-352b-4697-a5d5-fb45c98fb4a3">Testing & Bug Squashing for Dragon Tools</a> for a faster response and to avoid duplication. </p>

        <p>If you have general questions about Habitica, post them to <a href="https://habitica.com/groups/tavern">Tavern</a> or <a href="https://habitica.com/groups/guild/5481ccf3-5d2d-48a9-a871-70a7380cee5a">Habitica Help: Ask a Question Guild</a>.</p>
    </div>
	
	<div id="documentationAndFormClose" class="showHideToggle closer" data-target="documentationAndForm" data-resettoggletext="documentationAndFormToggle">hide documentation</div>
	
</div><!-- end of div id="documentationAndForm" -->
	
</div><!-- end of div id="innerBody" -->
</body>
</html>	
